#!/usr/bin/env jruby

# Copyright 2012 Lance Ball
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#    http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

$: << File.join(File.dirname(__FILE__), '..', 'lib')

require 'thor'
require 'fileutils'
require 'torquebox-rake-support'
require 'torquebox/console/client'

class TorqueBoxConsoleCommand < Thor

  DEPLOYMENT_NAME = 'torquebox-console-knob.yml'

  desc "deploy --dir=<deploy_dir> [--secure=username:password[,username:password]*]", 
  <<-EOT
Writes the torquebox-console application to disk in the directory specified by 
--dir, and deploys the app to the TorqueBox instance specified by ENV['TORQUEBOX_HOME']
(currently #{ENV['TORQUEBOX_HOME']}).

If --dir is not provided, the torquebox-console app will be written to Dir.pwd/torquebox-console
(currently #{Dir.pwd}/torquebox-console). 

EOT
  method_option :secure, :type => :hash, :default => nil
  method_option :dir, :type => :string, :default => "#{Dir.pwd}/torquebox-console"
  def deploy
    check
    descriptor = TorqueBox::DeployUtils.basic_deployment_descriptor( :root => options[:dir],
                                                                     :env => 'production' )
    if options[:secure]
      descriptor['environment']['REQUIRE_AUTHENTICATION'] = true
      descriptor['auth'] = {'console' => {'domain'=>'torquebox-torquebox-console', 'credentials'=>{}}}
      options[:secure].each do |user, pass|
        descriptor['auth']['console']['credentials'][user] = pass
      end
      puts ">> Wrote user/password entries to TorqueBox::Console deployment descriptor"
    else
      puts ">> WARNING: deploying TorqueBox::Console with no security - use the --secure=username:password option to secure it"
    end

    unless File.exist?( options[:dir] )
      puts ">> Creating torquebox-console app directory #{options[:dir]}."
      Dir.mkdir( options[:dir] ) 
    end
    puts "Copying torquebox-console app to #{options[:dir]}"
    files = Dir.glob("*") - ["bin", "torquebox-console.gemspec", "TODO", "VERSION"]
    FileUtils.cp_r( files, "#{options[:dir]}/", :verbose=>true )
    name, dir = TorqueBox::DeployUtils.deploy_yaml( descriptor, :name => DEPLOYMENT_NAME )
    puts ">> Deployed #{options[:dir]} as #{name} to #{dir}/#{name}"
  end

  desc "undeploy", "Undeploys TorqueBox::Console from the TorqueBox instance specified by $TORQUEBOX_HOME"
  def undeploy
    check
    name, dir = TorqueBox::DeployUtils.undeploy_yaml( :name => DEPLOYMENT_NAME )

    puts ">> Undeployed #{name} from #{dir}" if name
  end

  desc "connect", "Runs the CLI console"
  def connect
    TorqueBox::Console::Client.connect
  end

  protected
  def check
    raise Exception.new("$TORQUEBOX_HOME must be set") unless ENV['TORQUEBOX_HOME']
  end

  def root_dir
    _root_dir_ = File.expand_path( File.join( File.dirname( __FILE__ ), '..' ) )
    if _root_dir_ =~/\.rvm/
      $stderr.puts "It looks like you're using RVM for your JRuby."
      $stderr.puts "TorqueBox has some trouble with load paths with an '@'."
    end
    _root_dir_
  end
end

TorqueBoxConsoleCommand.start(ARGV)
